<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат</title>
  <script src="/js/lib/sockjs.min.js"></script>
  <script src="/js/lib/stomp.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    header { background: #2c3e50; color: white; padding: 1rem; margin-bottom: 1rem; }
    .chat-container { border: 1px solid #ddd; height: 500px; overflow-y: auto; padding: 1rem; margin-bottom: 1rem; }
    .message { margin-bottom: 1rem; padding: 0.5rem; border-radius: 5px; }
    .my-message { background: #e3f2fd; margin-left: 20%; text-align: right; }
    .other-message { background: #f5f5f5; margin-right: 20%; }
    .message-sender { font-weight: bold; color: #666; font-size: 0.9rem; }
    .input-container { display: flex; gap: 10px; }
    #message-input { flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 3px; }
    #send-button { background: #3498db; color: white; padding: 0.5rem 1rem; border: none; border-radius: 3px; cursor: pointer; }
    #send-button:hover { background: #2980b9; }
    .connection-status { padding: 0.5rem; margin-bottom: 1rem; border-radius: 3px; }
    .connected { background: #d4edda; color: #155724; }
    .disconnected { background: #f8d7da; color: #721c24; }
    .connecting { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Чат по объявлению</h1>
    <div id="chat-info">Загрузка информации о чате...</div>
  </header>

  <nav style="margin-bottom: 1rem;">
    <a href="/index.html" class="btn">Объявления</a>
    <a href="/chat-list.html" class="btn">Мои чаты</a>
  </nav>

  <div id="auth-section">
    <input type="text" id="username" placeholder="Username" value="testuser1">
    <input type="password" id="password" placeholder="Password" value="password123">
    <button onclick="connect()" class="btn">Подключиться к чату</button>
    <button onclick="disconnect()" class="btn">Отключиться</button>
  </div>

  <div id="connection-status" class="connection-status disconnected">Не подключено</div>

  <div id="chat-container" class="chat-container">
    <!-- Сообщения будут появляться здесь -->
  </div>

  <div class="input-container">
    <input type="text" id="message-input" placeholder="Введите сообщение..." disabled>
    <button id="send-button" onclick="sendMessage()" disabled>Отправить</button>
  </div>

  <div style="margin-top: 1rem;">
    <a href="/index.html" class="btn">← Назад к объявлениям</a>
  </div>
</div>

<script>
  // Упрощенная версия - давай начнем с basics
  let stompClient = null;
  let currentChatId = null;

  // Проверяем что все элементы существуют перед работой с ними
  function ensureElements() {
      const requiredElements = [
          'chat-info', 'username', 'password', 'connection-status',
          'chat-container', 'message-input', 'send-button'
      ];

      requiredElements.forEach(id => {
          if (!document.getElementById(id)) {
              console.error('Element not found:', id);
          }
      });
  }

  function updateChatInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      const advertId = urlParams.get('advertId');
      const recipientId = urlParams.get('recipientId');

      const chatInfo = document.getElementById('chat-info');
      if (chatInfo) {
          chatInfo.textContent = `Объявление ID: ${advertId}, Получатель ID: ${recipientId}`;
      }
  }

  function updateConnectionStatus(status, message) {
      const statusDiv = document.getElementById('connection-status');
      if (statusDiv) {
          statusDiv.textContent = message;
          statusDiv.className = `connection-status ${status}`;
      }
  }

  async function connect() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (!username || !password) {
          alert('Введите username и password');
          return;
      }

      updateConnectionStatus('connecting', 'Подключаемся...');

      try {
          // 1. Создаем/получаем чат
          const chat = await createOrGetChat(username, password);
          currentChatId = chat.id;

          // 2. Подключаемся к WebSocket
          connectWebSocket(username);

      } catch (error) {
          console.error('Connection failed:', error);
          updateConnectionStatus('disconnected', 'Ошибка: ' + error.message);
      }
  }

  async function createOrGetChat(username, password) {
      const urlParams = new URLSearchParams(window.location.search);
      const advertId = urlParams.get('advertId');
      const recipientId = urlParams.get('recipientId');

      const response = await fetch('/api/chats', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Basic ' + btoa(username + ':' + password)
          },
          body: JSON.stringify({
              advertId: parseInt(advertId),
              recipientId: parseInt(recipientId)
          })
      });

      if (!response.ok) {
          throw new Error('Ошибка создания чата: ' + response.status);
      }

      return await response.json();
  }

  function connectWebSocket(username) {
    console.log('Creating SockJS connection...');
    const socket = new SockJS('http://localhost:8080/ws');
    stompClient = Stomp.over(socket);

    // Включаем debug logging
    stompClient.debug = function(str) {
        console.log('STOMP debug:', str);
    };

    console.log('Attempting STOMP connection...');
    stompClient.connect(
        { 'username': username },
        function(frame) {
            console.log('✅ STOMP Connected successfully:', frame);
            updateConnectionStatus('connected', 'Подключено!');

            // Подписываемся на топик чата
            console.log('Subscribing to topic:', '/topic/chat.' + currentChatId);
            const subscription = stompClient.subscribe('/topic/chat.' + currentChatId, function(message) {
                console.log('✅ Message received from server:', message.body);
                try {
                    const messageData = JSON.parse(message.body);
                    displayMessage(messageData);
                } catch (e) {
                    console.error('❌ Parse error:', e, message.body);
                }
            });

            console.log('Subscription result:', subscription);

            // Загружаем историю сообщений
            loadMessageHistory();

            // Активируем поле ввода
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('message-input').focus();
        },
        function(error) {
            console.error('❌ STOMP Connection error:', error);
            updateConnectionStatus('disconnected', 'Ошибка подключения');
        }
    );
  }

  function disconnect() {
      if (stompClient) {
          stompClient.disconnect();
      }
      updateConnectionStatus('disconnected', 'Отключено');
      document.getElementById('message-input').disabled = true;
      document.getElementById('send-button').disabled = true;
  }

  function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();

    if (messageText && stompClient) {
        console.log('Sending message:', messageText);

        const message = {
            text: messageText,
            timestamp: new Date().toISOString()
        };

        const destination = '/app/chat/' + currentChatId + '/send';
        console.log('Sending to destination:', destination);

        stompClient.send(destination, {}, JSON.stringify(message));
        messageInput.value = '';
    } else {
        console.log('Cannot send message - check connection');
    }
  }

  async function loadMessageHistory() {
      try {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;

          const response = await fetch(`/api/chats/${currentChatId}/messages`, {
              headers: {
                  'Authorization': 'Basic ' + btoa(username + ':' + password)
              }
          });

          if (response.ok) {
              const messages = await response.json();
              messages.forEach(displayMessage);
          }
      } catch (error) {
          console.error('Error loading history:', error);
      }
  }

  function displayMessage(message) {
      const chatContainer = document.getElementById('chat-container');
      if (!chatContainer) return;

      const messageDiv = document.createElement('div');
      const isMyMessage = message.sender.username === document.getElementById('username').value;

      messageDiv.className = isMyMessage ? 'message my-message' : 'message other-message';
      messageDiv.innerHTML = `
          <div class="message-sender">${message.sender.username}</div>
          <div>${message.text}</div>
          <div style="font-size: 0.8rem; color: #666;">
              ${new Date(message.timestamp).toLocaleString()}
          </div>
      `;

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Инициализация при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
      ensureElements();
      updateChatInfo();

      // Обработчик Enter для отправки сообщения
      document.getElementById('message-input').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              sendMessage();
          }
      });
  });
</script>
</body>
</html>